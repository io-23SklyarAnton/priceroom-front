{"version":3,"names":["_typeof","o","Symbol","iterator","constructor","prototype","Object","defineProperty","exports","value","_stream","_interopRequireDefault","require","_utils","e","__esModule","_classCallCheck","a","n","TypeError","_defineProperties","r","t","length","enumerable","configurable","writable","_toPropertyKey","key","_createClass","i","_toPrimitive","toPrimitive","call","String","Number","_callSuper","_getPrototypeOf","_possibleConstructorReturn","_isNativeReflectConstruct","Reflect","construct","apply","_assertThisInitialized","ReferenceError","Boolean","valueOf","_superPropGet","p","_get","get","bind","_superPropBase","getOwnPropertyDescriptor","arguments","hasOwnProperty","setPrototypeOf","getPrototypeOf","__proto__","_inherits","create","_setPrototypeOf","kInternals","AxiosTransformStream","_stream$Transform","options","_this","utils","toFlatObject","maxRate","chunkSize","minChunkSize","timeWindow","ticksRate","samplesCount","prop","source","isUndefined","readableHighWaterMark","internals","bytesSeen","isCaptured","notifiedBytesLoaded","ts","Date","now","bytes","onReadCallback","on","event","_read","size","_transform","chunk","encoding","callback","_this2","divider","bytesThreshold","Math","max","pushChunk","_chunk","_callback","Buffer","byteLength","emit","push","process","nextTick","transformChunk","chunkRemainder","maxChunkSize","bytesLeft","passed","setTimeout","subarray","transformNextChunk","err","stream","Transform","_default"],"sources":["AxiosTransformStream.js"],"sourcesContent":["'use strict';\n\nimport stream from 'stream';\nimport utils from '../utils.js';\n\nconst kInternals = Symbol('internals');\n\nclass AxiosTransformStream extends stream.Transform{\n  constructor(options) {\n    options = utils.toFlatObject(options, {\n      maxRate: 0,\n      chunkSize: 64 * 1024,\n      minChunkSize: 100,\n      timeWindow: 500,\n      ticksRate: 2,\n      samplesCount: 15\n    }, null, (prop, source) => {\n      return !utils.isUndefined(source[prop]);\n    });\n\n    super({\n      readableHighWaterMark: options.chunkSize\n    });\n\n    const internals = this[kInternals] = {\n      timeWindow: options.timeWindow,\n      chunkSize: options.chunkSize,\n      maxRate: options.maxRate,\n      minChunkSize: options.minChunkSize,\n      bytesSeen: 0,\n      isCaptured: false,\n      notifiedBytesLoaded: 0,\n      ts: Date.now(),\n      bytes: 0,\n      onReadCallback: null\n    };\n\n    this.on('newListener', event => {\n      if (event === 'progress') {\n        if (!internals.isCaptured) {\n          internals.isCaptured = true;\n        }\n      }\n    });\n  }\n\n  _read(size) {\n    const internals = this[kInternals];\n\n    if (internals.onReadCallback) {\n      internals.onReadCallback();\n    }\n\n    return super._read(size);\n  }\n\n  _transform(chunk, encoding, callback) {\n    const internals = this[kInternals];\n    const maxRate = internals.maxRate;\n\n    const readableHighWaterMark = this.readableHighWaterMark;\n\n    const timeWindow = internals.timeWindow;\n\n    const divider = 1000 / timeWindow;\n    const bytesThreshold = (maxRate / divider);\n    const minChunkSize = internals.minChunkSize !== false ? Math.max(internals.minChunkSize, bytesThreshold * 0.01) : 0;\n\n    const pushChunk = (_chunk, _callback) => {\n      const bytes = Buffer.byteLength(_chunk);\n      internals.bytesSeen += bytes;\n      internals.bytes += bytes;\n\n      internals.isCaptured && this.emit('progress', internals.bytesSeen);\n\n      if (this.push(_chunk)) {\n        process.nextTick(_callback);\n      } else {\n        internals.onReadCallback = () => {\n          internals.onReadCallback = null;\n          process.nextTick(_callback);\n        };\n      }\n    }\n\n    const transformChunk = (_chunk, _callback) => {\n      const chunkSize = Buffer.byteLength(_chunk);\n      let chunkRemainder = null;\n      let maxChunkSize = readableHighWaterMark;\n      let bytesLeft;\n      let passed = 0;\n\n      if (maxRate) {\n        const now = Date.now();\n\n        if (!internals.ts || (passed = (now - internals.ts)) >= timeWindow) {\n          internals.ts = now;\n          bytesLeft = bytesThreshold - internals.bytes;\n          internals.bytes = bytesLeft < 0 ? -bytesLeft : 0;\n          passed = 0;\n        }\n\n        bytesLeft = bytesThreshold - internals.bytes;\n      }\n\n      if (maxRate) {\n        if (bytesLeft <= 0) {\n          // next time window\n          return setTimeout(() => {\n            _callback(null, _chunk);\n          }, timeWindow - passed);\n        }\n\n        if (bytesLeft < maxChunkSize) {\n          maxChunkSize = bytesLeft;\n        }\n      }\n\n      if (maxChunkSize && chunkSize > maxChunkSize && (chunkSize - maxChunkSize) > minChunkSize) {\n        chunkRemainder = _chunk.subarray(maxChunkSize);\n        _chunk = _chunk.subarray(0, maxChunkSize);\n      }\n\n      pushChunk(_chunk, chunkRemainder ? () => {\n        process.nextTick(_callback, null, chunkRemainder);\n      } : _callback);\n    };\n\n    transformChunk(chunk, function transformNextChunk(err, _chunk) {\n      if (err) {\n        return callback(err);\n      }\n\n      if (_chunk) {\n        transformChunk(_chunk, transformNextChunk);\n      } else {\n        callback(null);\n      }\n    });\n  }\n}\n\nexport default AxiosTransformStream;\n"],"mappings":"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","ignoreList":[]}