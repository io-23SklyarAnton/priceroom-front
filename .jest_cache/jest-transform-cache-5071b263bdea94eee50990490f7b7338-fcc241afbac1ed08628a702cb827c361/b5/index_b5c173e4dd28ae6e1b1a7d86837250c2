1c7186b41458aa006af270575b14acf1
'use strict';

var parseUrl = require('url').parse;
var DEFAULT_PORTS = {
  ftp: 21,
  gopher: 70,
  http: 80,
  https: 443,
  ws: 80,
  wss: 443
};
var stringEndsWith = String.prototype.endsWith || function (s) {
  return s.length <= this.length && this.indexOf(s, this.length - s.length) !== -1;
};

/**
 * @param {string|object} url - The URL, or the result from url.parse.
 * @return {string} The URL of the proxy that should handle the request to the
 *  given URL. If no proxy is set, this will be an empty string.
 */
function getProxyForUrl(url) {
  var parsedUrl = typeof url === 'string' ? parseUrl(url) : url || {};
  var proto = parsedUrl.protocol;
  var hostname = parsedUrl.host;
  var port = parsedUrl.port;
  if (typeof hostname !== 'string' || !hostname || typeof proto !== 'string') {
    return ''; // Don't proxy URLs without a valid scheme or host.
  }
  proto = proto.split(':', 1)[0];
  // Stripping ports in this way instead of using parsedUrl.hostname to make
  // sure that the brackets around IPv6 addresses are kept.
  hostname = hostname.replace(/:\d*$/, '');
  port = parseInt(port) || DEFAULT_PORTS[proto] || 0;
  if (!shouldProxy(hostname, port)) {
    return ''; // Don't proxy URLs that match NO_PROXY.
  }
  var proxy = getEnv('npm_config_' + proto + '_proxy') || getEnv(proto + '_proxy') || getEnv('npm_config_proxy') || getEnv('all_proxy');
  if (proxy && proxy.indexOf('://') === -1) {
    // Missing scheme in proxy, default to the requested URL's scheme.
    proxy = proto + '://' + proxy;
  }
  return proxy;
}

/**
 * Determines whether a given URL should be proxied.
 *
 * @param {string} hostname - The host name of the URL.
 * @param {number} port - The effective port of the URL.
 * @returns {boolean} Whether the given URL should be proxied.
 * @private
 */
function shouldProxy(hostname, port) {
  var NO_PROXY = (getEnv('npm_config_no_proxy') || getEnv('no_proxy')).toLowerCase();
  if (!NO_PROXY) {
    return true; // Always proxy if NO_PROXY is not set.
  }
  if (NO_PROXY === '*') {
    return false; // Never proxy if wildcard is set.
  }
  return NO_PROXY.split(/[,\s]/).every(function (proxy) {
    if (!proxy) {
      return true; // Skip zero-length hosts.
    }
    var parsedProxy = proxy.match(/^(.+):(\d+)$/);
    var parsedProxyHostname = parsedProxy ? parsedProxy[1] : proxy;
    var parsedProxyPort = parsedProxy ? parseInt(parsedProxy[2]) : 0;
    if (parsedProxyPort && parsedProxyPort !== port) {
      return true; // Skip if ports don't match.
    }
    if (!/^[.*]/.test(parsedProxyHostname)) {
      // No wildcards, so stop proxying if there is an exact match.
      return hostname !== parsedProxyHostname;
    }
    if (parsedProxyHostname.charAt(0) === '*') {
      // Remove leading wildcard.
      parsedProxyHostname = parsedProxyHostname.slice(1);
    }
    // Stop proxying if the hostname ends with the no_proxy host.
    return !stringEndsWith.call(hostname, parsedProxyHostname);
  });
}

/**
 * Get the value for an environment variable.
 *
 * @param {string} key - The name of the environment variable.
 * @return {string} The value of the environment variable.
 * @private
 */
function getEnv(key) {
  return process.env[key.toLowerCase()] || process.env[key.toUpperCase()] || '';
}
exports.getProxyForUrl = getProxyForUrl;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJwYXJzZVVybCIsInJlcXVpcmUiLCJwYXJzZSIsIkRFRkFVTFRfUE9SVFMiLCJmdHAiLCJnb3BoZXIiLCJodHRwIiwiaHR0cHMiLCJ3cyIsIndzcyIsInN0cmluZ0VuZHNXaXRoIiwiU3RyaW5nIiwicHJvdG90eXBlIiwiZW5kc1dpdGgiLCJzIiwibGVuZ3RoIiwiaW5kZXhPZiIsImdldFByb3h5Rm9yVXJsIiwidXJsIiwicGFyc2VkVXJsIiwicHJvdG8iLCJwcm90b2NvbCIsImhvc3RuYW1lIiwiaG9zdCIsInBvcnQiLCJzcGxpdCIsInJlcGxhY2UiLCJwYXJzZUludCIsInNob3VsZFByb3h5IiwicHJveHkiLCJnZXRFbnYiLCJOT19QUk9YWSIsInRvTG93ZXJDYXNlIiwiZXZlcnkiLCJwYXJzZWRQcm94eSIsIm1hdGNoIiwicGFyc2VkUHJveHlIb3N0bmFtZSIsInBhcnNlZFByb3h5UG9ydCIsInRlc3QiLCJjaGFyQXQiLCJzbGljZSIsImNhbGwiLCJrZXkiLCJwcm9jZXNzIiwiZW52IiwidG9VcHBlckNhc2UiLCJleHBvcnRzIl0sInNvdXJjZXMiOlsiaW5kZXguanMiXSwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG52YXIgcGFyc2VVcmwgPSByZXF1aXJlKCd1cmwnKS5wYXJzZTtcblxudmFyIERFRkFVTFRfUE9SVFMgPSB7XG4gIGZ0cDogMjEsXG4gIGdvcGhlcjogNzAsXG4gIGh0dHA6IDgwLFxuICBodHRwczogNDQzLFxuICB3czogODAsXG4gIHdzczogNDQzLFxufTtcblxudmFyIHN0cmluZ0VuZHNXaXRoID0gU3RyaW5nLnByb3RvdHlwZS5lbmRzV2l0aCB8fCBmdW5jdGlvbihzKSB7XG4gIHJldHVybiBzLmxlbmd0aCA8PSB0aGlzLmxlbmd0aCAmJlxuICAgIHRoaXMuaW5kZXhPZihzLCB0aGlzLmxlbmd0aCAtIHMubGVuZ3RoKSAhPT0gLTE7XG59O1xuXG4vKipcbiAqIEBwYXJhbSB7c3RyaW5nfG9iamVjdH0gdXJsIC0gVGhlIFVSTCwgb3IgdGhlIHJlc3VsdCBmcm9tIHVybC5wYXJzZS5cbiAqIEByZXR1cm4ge3N0cmluZ30gVGhlIFVSTCBvZiB0aGUgcHJveHkgdGhhdCBzaG91bGQgaGFuZGxlIHRoZSByZXF1ZXN0IHRvIHRoZVxuICogIGdpdmVuIFVSTC4gSWYgbm8gcHJveHkgaXMgc2V0LCB0aGlzIHdpbGwgYmUgYW4gZW1wdHkgc3RyaW5nLlxuICovXG5mdW5jdGlvbiBnZXRQcm94eUZvclVybCh1cmwpIHtcbiAgdmFyIHBhcnNlZFVybCA9IHR5cGVvZiB1cmwgPT09ICdzdHJpbmcnID8gcGFyc2VVcmwodXJsKSA6IHVybCB8fCB7fTtcbiAgdmFyIHByb3RvID0gcGFyc2VkVXJsLnByb3RvY29sO1xuICB2YXIgaG9zdG5hbWUgPSBwYXJzZWRVcmwuaG9zdDtcbiAgdmFyIHBvcnQgPSBwYXJzZWRVcmwucG9ydDtcbiAgaWYgKHR5cGVvZiBob3N0bmFtZSAhPT0gJ3N0cmluZycgfHwgIWhvc3RuYW1lIHx8IHR5cGVvZiBwcm90byAhPT0gJ3N0cmluZycpIHtcbiAgICByZXR1cm4gJyc7ICAvLyBEb24ndCBwcm94eSBVUkxzIHdpdGhvdXQgYSB2YWxpZCBzY2hlbWUgb3IgaG9zdC5cbiAgfVxuXG4gIHByb3RvID0gcHJvdG8uc3BsaXQoJzonLCAxKVswXTtcbiAgLy8gU3RyaXBwaW5nIHBvcnRzIGluIHRoaXMgd2F5IGluc3RlYWQgb2YgdXNpbmcgcGFyc2VkVXJsLmhvc3RuYW1lIHRvIG1ha2VcbiAgLy8gc3VyZSB0aGF0IHRoZSBicmFja2V0cyBhcm91bmQgSVB2NiBhZGRyZXNzZXMgYXJlIGtlcHQuXG4gIGhvc3RuYW1lID0gaG9zdG5hbWUucmVwbGFjZSgvOlxcZCokLywgJycpO1xuICBwb3J0ID0gcGFyc2VJbnQocG9ydCkgfHwgREVGQVVMVF9QT1JUU1twcm90b10gfHwgMDtcbiAgaWYgKCFzaG91bGRQcm94eShob3N0bmFtZSwgcG9ydCkpIHtcbiAgICByZXR1cm4gJyc7ICAvLyBEb24ndCBwcm94eSBVUkxzIHRoYXQgbWF0Y2ggTk9fUFJPWFkuXG4gIH1cblxuICB2YXIgcHJveHkgPVxuICAgIGdldEVudignbnBtX2NvbmZpZ18nICsgcHJvdG8gKyAnX3Byb3h5JykgfHxcbiAgICBnZXRFbnYocHJvdG8gKyAnX3Byb3h5JykgfHxcbiAgICBnZXRFbnYoJ25wbV9jb25maWdfcHJveHknKSB8fFxuICAgIGdldEVudignYWxsX3Byb3h5Jyk7XG4gIGlmIChwcm94eSAmJiBwcm94eS5pbmRleE9mKCc6Ly8nKSA9PT0gLTEpIHtcbiAgICAvLyBNaXNzaW5nIHNjaGVtZSBpbiBwcm94eSwgZGVmYXVsdCB0byB0aGUgcmVxdWVzdGVkIFVSTCdzIHNjaGVtZS5cbiAgICBwcm94eSA9IHByb3RvICsgJzovLycgKyBwcm94eTtcbiAgfVxuICByZXR1cm4gcHJveHk7XG59XG5cbi8qKlxuICogRGV0ZXJtaW5lcyB3aGV0aGVyIGEgZ2l2ZW4gVVJMIHNob3VsZCBiZSBwcm94aWVkLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBob3N0bmFtZSAtIFRoZSBob3N0IG5hbWUgb2YgdGhlIFVSTC5cbiAqIEBwYXJhbSB7bnVtYmVyfSBwb3J0IC0gVGhlIGVmZmVjdGl2ZSBwb3J0IG9mIHRoZSBVUkwuXG4gKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2hldGhlciB0aGUgZ2l2ZW4gVVJMIHNob3VsZCBiZSBwcm94aWVkLlxuICogQHByaXZhdGVcbiAqL1xuZnVuY3Rpb24gc2hvdWxkUHJveHkoaG9zdG5hbWUsIHBvcnQpIHtcbiAgdmFyIE5PX1BST1hZID1cbiAgICAoZ2V0RW52KCducG1fY29uZmlnX25vX3Byb3h5JykgfHwgZ2V0RW52KCdub19wcm94eScpKS50b0xvd2VyQ2FzZSgpO1xuICBpZiAoIU5PX1BST1hZKSB7XG4gICAgcmV0dXJuIHRydWU7ICAvLyBBbHdheXMgcHJveHkgaWYgTk9fUFJPWFkgaXMgbm90IHNldC5cbiAgfVxuICBpZiAoTk9fUFJPWFkgPT09ICcqJykge1xuICAgIHJldHVybiBmYWxzZTsgIC8vIE5ldmVyIHByb3h5IGlmIHdpbGRjYXJkIGlzIHNldC5cbiAgfVxuXG4gIHJldHVybiBOT19QUk9YWS5zcGxpdCgvWyxcXHNdLykuZXZlcnkoZnVuY3Rpb24ocHJveHkpIHtcbiAgICBpZiAoIXByb3h5KSB7XG4gICAgICByZXR1cm4gdHJ1ZTsgIC8vIFNraXAgemVyby1sZW5ndGggaG9zdHMuXG4gICAgfVxuICAgIHZhciBwYXJzZWRQcm94eSA9IHByb3h5Lm1hdGNoKC9eKC4rKTooXFxkKykkLyk7XG4gICAgdmFyIHBhcnNlZFByb3h5SG9zdG5hbWUgPSBwYXJzZWRQcm94eSA/IHBhcnNlZFByb3h5WzFdIDogcHJveHk7XG4gICAgdmFyIHBhcnNlZFByb3h5UG9ydCA9IHBhcnNlZFByb3h5ID8gcGFyc2VJbnQocGFyc2VkUHJveHlbMl0pIDogMDtcbiAgICBpZiAocGFyc2VkUHJveHlQb3J0ICYmIHBhcnNlZFByb3h5UG9ydCAhPT0gcG9ydCkge1xuICAgICAgcmV0dXJuIHRydWU7ICAvLyBTa2lwIGlmIHBvcnRzIGRvbid0IG1hdGNoLlxuICAgIH1cblxuICAgIGlmICghL15bLipdLy50ZXN0KHBhcnNlZFByb3h5SG9zdG5hbWUpKSB7XG4gICAgICAvLyBObyB3aWxkY2FyZHMsIHNvIHN0b3AgcHJveHlpbmcgaWYgdGhlcmUgaXMgYW4gZXhhY3QgbWF0Y2guXG4gICAgICByZXR1cm4gaG9zdG5hbWUgIT09IHBhcnNlZFByb3h5SG9zdG5hbWU7XG4gICAgfVxuXG4gICAgaWYgKHBhcnNlZFByb3h5SG9zdG5hbWUuY2hhckF0KDApID09PSAnKicpIHtcbiAgICAgIC8vIFJlbW92ZSBsZWFkaW5nIHdpbGRjYXJkLlxuICAgICAgcGFyc2VkUHJveHlIb3N0bmFtZSA9IHBhcnNlZFByb3h5SG9zdG5hbWUuc2xpY2UoMSk7XG4gICAgfVxuICAgIC8vIFN0b3AgcHJveHlpbmcgaWYgdGhlIGhvc3RuYW1lIGVuZHMgd2l0aCB0aGUgbm9fcHJveHkgaG9zdC5cbiAgICByZXR1cm4gIXN0cmluZ0VuZHNXaXRoLmNhbGwoaG9zdG5hbWUsIHBhcnNlZFByb3h5SG9zdG5hbWUpO1xuICB9KTtcbn1cblxuLyoqXG4gKiBHZXQgdGhlIHZhbHVlIGZvciBhbiBlbnZpcm9ubWVudCB2YXJpYWJsZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIG5hbWUgb2YgdGhlIGVudmlyb25tZW50IHZhcmlhYmxlLlxuICogQHJldHVybiB7c3RyaW5nfSBUaGUgdmFsdWUgb2YgdGhlIGVudmlyb25tZW50IHZhcmlhYmxlLlxuICogQHByaXZhdGVcbiAqL1xuZnVuY3Rpb24gZ2V0RW52KGtleSkge1xuICByZXR1cm4gcHJvY2Vzcy5lbnZba2V5LnRvTG93ZXJDYXNlKCldIHx8IHByb2Nlc3MuZW52W2tleS50b1VwcGVyQ2FzZSgpXSB8fCAnJztcbn1cblxuZXhwb3J0cy5nZXRQcm94eUZvclVybCA9IGdldFByb3h5Rm9yVXJsO1xuIl0sIm1hcHBpbmdzIjoiQUFBQSxZQUFZOztBQUVaLElBQUlBLFFBQVEsR0FBR0MsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDQyxLQUFLO0FBRW5DLElBQUlDLGFBQWEsR0FBRztFQUNsQkMsR0FBRyxFQUFFLEVBQUU7RUFDUEMsTUFBTSxFQUFFLEVBQUU7RUFDVkMsSUFBSSxFQUFFLEVBQUU7RUFDUkMsS0FBSyxFQUFFLEdBQUc7RUFDVkMsRUFBRSxFQUFFLEVBQUU7RUFDTkMsR0FBRyxFQUFFO0FBQ1AsQ0FBQztBQUVELElBQUlDLGNBQWMsR0FBR0MsTUFBTSxDQUFDQyxTQUFTLENBQUNDLFFBQVEsSUFBSSxVQUFTQyxDQUFDLEVBQUU7RUFDNUQsT0FBT0EsQ0FBQyxDQUFDQyxNQUFNLElBQUksSUFBSSxDQUFDQSxNQUFNLElBQzVCLElBQUksQ0FBQ0MsT0FBTyxDQUFDRixDQUFDLEVBQUUsSUFBSSxDQUFDQyxNQUFNLEdBQUdELENBQUMsQ0FBQ0MsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ2xELENBQUM7O0FBRUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVNFLGNBQWNBLENBQUND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